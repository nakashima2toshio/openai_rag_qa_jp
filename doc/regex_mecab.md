# 正規表現とMeCabを統合したキーワード抽出システム

## 概要

`regex_mecab.py`は、MeCab（形態素解析器）と正規表現を統合した、ロバストな日本語キーワード抽出システムです。MeCabが利用可能な環境では高精度な複合名詞抽出を行い、利用不可の場合は正規表現ベースの抽出に自動的にフォールバックします。

## システムアーキテクチャ

### 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    KeywordExtractor                          │
│                  (キーワード抽出器本体)                        │
└─────────────────────────────────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
        ┌───────▼──────┐       ┌───────▼──────┐
        │  MeCab利用可  │       │  MeCab利用不可│
        │   能性チェック │       │   (フォール  │
        │  _check_mecab_│       │   バック)    │
        │  availability()│       │              │
        └───────┬──────┘       └───────┬──────┘
                │                       │
        ┌───────▼──────────┐   ┌───────▼──────────┐
        │ MeCab複合名詞抽出 │   │  正規表現パターン │
        │_extract_with_mecab│   │ _extract_with_regex│
        │                   │   │                   │
        │・名詞連続抽出     │   │・カタカナ語抽出  │
        │・品詞解析        │   │・漢字複合語抽出  │
        │・複合名詞生成    │   │・英数字抽出      │
        └───────┬──────────┘   └───────┬──────────┘
                │                       │
                └───────────┬───────────┘
                            │
                ┌───────────▼───────────┐
                │   スコアリングシステム   │
                │  _score_and_rank()      │
                │                         │
                │・頻度スコア (30%)       │
                │・長さスコア (30%)       │
                │・重要語ブースト (50%)   │
                │・文字種スコア (15-30%)  │
                └───────────┬───────────┘
                            │
                ┌───────────▼───────────┐
                │  フィルタリング処理    │
                │・ストップワード除去    │
                │・短すぎる語の除去      │
                │・上位N件抽出          │
                └───────────┬───────────┘
                            │
                ┌───────────▼───────────┐
                │   キーワードリスト     │
                │   (抽出結果)          │
                └───────────────────────┘
```

### 処理モード

```
入力テキスト
    │
    ▼
┌─────────────────┐
│ prefer_mecab?   │
│ MeCab available?│
└────┬────────────┘
     │
     ├─ YES ─→ [MeCabモード]
     │         ├─ 形態素解析
     │         ├─ 複合名詞抽出
     │         └─ 高精度キーワード
     │
     ├─ NO ──→ [正規表現モード]
     │         ├─ パターンマッチ
     │         ├─ 文字種別抽出
     │         └─ 汎用キーワード
     │
     └─ BOTH → [統合モード]
               ├─ 両手法を実行
               ├─ 結果マージ
               └─ 統合スコアリング
```

## 主な特徴

### 1. 自動フォールバック機能
- MeCabが利用可能：複合名詞抽出モード（高精度）
- MeCab不可：正規表現モード（環境非依存）
- 実行時に自動判定し、最適な手法を選択

### 2. 多様な抽出手法

#### MeCab複合名詞抽出
- 連続する名詞を複合名詞として抽出
- 形態素解析による正確な品詞判定
- 専門用語や固有名詞の認識精度が高い

#### 正規表現ベース抽出
```python
pattern = r'[ァ-ヴー]{2,}|[一-龥]{2,}|[A-Za-z]{2,}[A-Za-z0-9]*'
```
- カタカナ語（2文字以上）
- 漢字複合語（2文字以上）
- 英数字（2文字以上の英字で始まる）

### 3. 高度なスコアリングシステム

キーワードの重要度を以下の要素で評価：

1. **頻度スコア** (30%)
   - 出現頻度を正規化（最大3回まで）

2. **長さスコア** (30%)
   - 複合語を優遇（最大8文字まで）

3. **重要キーワードブースト** (50%)
   - AI、機械学習、NLPなど事前定義された重要語

4. **文字種スコア** (15-30%)
   - カタカナ3文字以上：+15%
   - 英大文字2文字以上：+20%
   - 漢字4文字以上：+15%

## 使用方法

### 基本的な使用

```python
from regex_mecab import KeywordExtractor

# 抽出器の初期化
extractor = KeywordExtractor()

# テキストからキーワード抽出
text = "人工知能と機械学習の分野では、深層学習が革新をもたらしています。"
keywords = extractor.extract(text, top_n=5)
print(keywords)
# 出力例: ['深層学習', '機械学習', '人工知能', '分野', '革新']
```

### 詳細情報付き抽出

```python
# 各手法の結果を比較
results = extractor.extract_with_details(text, top_n=10)

for method, keywords_scored in results.items():
    print(f"\n【{method}】")
    for keyword, score in keywords_scored:
        print(f"  {keyword}: {score:.3f}")
```

### カバレージ評価

```python
from regex_mecab import evaluate_coverage_potential

# キーワードのカバレージ改善ポテンシャルを評価
metrics = evaluate_coverage_potential(keywords, uncovered_text)
print(f"カバレージ率: {metrics['キーワードカバレージ率']:.2%}")
print(f"複合語率: {metrics['複合語率']:.2%}")
print(f"専門用語率: {metrics['専門用語率']:.2%}")
```

## 処理フロー詳細

### 1. 基本的な抽出フロー（extract メソッド）

```
┌─────────────────────────────────────────────────┐
│  extractor.extract(text, top_n=5, use_scoring=True) │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
     ┌─────────────────────────┐
     │ MeCab利用可能かチェック  │
     │ (self.mecab_available)  │
     └────────┬────────────────┘
              │
     ┌────────┴────────┐
     │                 │
  [YES]             [NO]
     │                 │
     ▼                 ▼
┌──────────────┐  ┌───────────────┐
│_extract_with_│  │_extract_with_ │
│   mecab()    │  │   regex()     │
└──────┬───────┘  └───────┬───────┘
       │                  │
       ▼                  ▼
┌──────────────────────────────┐
│  use_scoring == True?        │
└──────┬───────────────────────┘
       │
   ┌───┴────┐
   │        │
 [YES]    [NO]
   │        │
   ▼        ▼
┌────────┐ ┌──────────────┐
│_score_ │ │_filter_and_  │
│and_rank│ │   count()    │
└───┬────┘ └──────┬───────┘
    │             │
    └──────┬──────┘
           ▼
    ┌─────────────┐
    │上位N件を返す │
    └─────────────┘
```

### 2. 詳細比較フロー（extract_with_details メソッド）

```
┌──────────────────────────────────────────────┐
│ extractor.extract_with_details(text, top_n=10)│
└─────────────────┬────────────────────────────┘
                  │
          ┌───────┴───────┐
          │               │
          ▼               ▼
  ┌──────────────┐  ┌──────────────┐
  │ MeCab複合名詞 │  │  正規表現版  │
  │    抽出      │  │    抽出      │
  │_extract_with_│  │_extract_with_│
  │mecab_scored()│  │regex_scored()│
  └──────┬───────┘  └──────┬───────┘
         │                 │
         │                 ▼
         │          ┌─────────────┐
         │          │  統合版抽出  │
         │          │_extract_    │
         │          │integrated() │
         │          └──────┬──────┘
         │                 │
         └────────┬────────┘
                  │
                  ▼
        ┌─────────────────┐
        │各手法のスコア計算 │
        │_calculate_      │
        │keyword_score()  │
        └────────┬────────┘
                 │
                 ▼
      ┌──────────────────────┐
      │結果の辞書形式で返却   │
      │{手法名: [(kw, score)]}│
      └──────────────────────┘
```

### 3. MeCab抽出の内部処理

```
_extract_with_mecab(text, top_n, use_scoring)
           │
           ▼
    ┌─────────────┐
    │ MeCab.Tagger│
    │  初期化     │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │parseToNode()│
    │形態素解析   │
    └──────┬──────┘
           │
           ▼
    ┌─────────────────────┐
    │ノードを順次走査      │
    │while node:          │
    └──────┬──────────────┘
           │
           ▼
    ┌─────────────────────┐
    │品詞が「名詞」?       │
    └──────┬──────────────┘
           │
      ┌────┴─────┐
      │          │
    [YES]      [NO]
      │          │
      ▼          ▼
  ┌─────────┐ ┌────────────┐
  │バッファに│ │バッファを   │
  │追加     │ │フラッシュ  │
  └─────────┘ └────────────┘
           │
           ▼
    ┌─────────────────┐
    │複合名詞リスト作成│
    └──────┬──────────┘
           │
           ▼
    ┌─────────────────┐
    │フィルタリング    │
    │・ストップワード  │
    │・長さチェック    │
    └──────┬──────────┘
           │
           ▼
    ┌─────────────────┐
    │上位N件返却       │
    └─────────────────┘
```

### 4. スコアリングアルゴリズム

```
_calculate_keyword_score(keyword, text)
           │
           ▼
    ┌─────────────────┐
    │  スコア初期化    │
    │  score = 0.0    │
    └──────┬──────────┘
           │
    ┌──────┴──────────────────┐
    │                         │
    ▼                         ▼
┌────────────┐          ┌────────────┐
│ 頻度スコア  │          │ 長さスコア  │
│freq = count│          │len(keyword)│
│score += 30%│          │score += 20%│
└──────┬─────┘          └──────┬─────┘
       │                       │
       └───────────┬───────────┘
                   │
            ┌──────┴──────┐
            │             │
            ▼             ▼
    ┌──────────────┐  ┌──────────────┐
    │重要語ブースト │  │文字種スコア   │
    │important_kw  │  │カタカナ +15% │
    │score += 40%  │  │英大文字 +20% │
    └──────┬───────┘  │漢字4+ +15%   │
           │          └──────┬───────┘
           │                 │
           └────────┬────────┘
                    │
                    ▼
            ┌───────────────┐
            │ 最終スコア返却 │
            │ min(score, 1.0)│
            └───────────────┘
```

### 5. カバレージ評価フロー

```
evaluate_coverage_potential(keywords, uncovered_text, analyzer)
                    │
            ┌───────┴───────┬───────────┬────────────┐
            │               │           │            │
            ▼               ▼           ▼            ▼
    ┌──────────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐
    │キーワード     │ │複合語率  │ │専門用語率│ │意味的    │
    │カバレージ率  │ │計算      │ │計算     │ │関連度    │
    │計算          │ │(len>=4)  │ │(pattern)│ │(embedding)│
    └──────┬───────┘ └────┬─────┘ └────┬────┘ └────┬─────┘
           │              │           │          │
           └──────────────┴───────────┴──────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │評価メトリクス  │
                  │辞書を返却     │
                  └───────────────┘
```

## クラス・関数リファレンス

### KeywordExtractor クラス

#### `__init__(prefer_mecab: bool = True)`
- **パラメータ**:
  - `prefer_mecab`: MeCabを優先的に使用するか（デフォルト：True）
- **初期化処理**:
  - MeCab利用可能性チェック
  - ストップワード辞書のセットアップ
  - 重要キーワード辞書のセットアップ

#### `extract(text: str, top_n: int = 5, use_scoring: bool = True) -> List[str]`
- **パラメータ**:
  - `text`: 分析対象テキスト
  - `top_n`: 抽出するキーワード数
  - `use_scoring`: スコアリングを使用するか
- **返り値**: キーワードのリスト
- **処理内容**:
  1. MeCab利用可能性を確認
  2. 利用可能なら`_extract_with_mecab()`を呼び出し
  3. 失敗時は`_extract_with_regex()`にフォールバック

#### `extract_with_details(text: str, top_n: int = 10) -> Dict[str, List[Tuple[str, float]]]`
- **パラメータ**:
  - `text`: 分析対象テキスト
  - `top_n`: 抽出するキーワード数
- **返り値**: `{手法名: [(キーワード, スコア), ...]}`
- **処理内容**:
  - MeCab複合名詞版
  - 正規表現版
  - 統合版（両手法をマージ）
  - 各手法の結果を辞書形式で返却

### 内部メソッド（プライベート）

#### `_check_mecab_availability() -> bool`
- MeCabのインポートとインスタンス化を試行
- 成功時True、失敗時Falseを返す

#### `_extract_with_mecab(text: str, top_n: int, use_scoring: bool) -> List[str]`
- 形態素解析による複合名詞抽出
- 連続する名詞をバッファリングして複合語生成

#### `_extract_with_regex(text: str, top_n: int, use_scoring: bool) -> List[str]`
- 正規表現パターンマッチによる単語抽出
- カタカナ、漢字、英数字の3パターン

#### `_filter_and_count(words: List[str], top_n: int) -> List[str]`
- 頻度ベースのシンプルフィルタリング
- ストップワード除去 + 頻度カウント

#### `_score_and_rank(words: List[str], top_n: int) -> List[str]`
- 高度なスコアリングシステム
- 頻度、長さ、重要語、文字種の4要素で評価

#### `_calculate_keyword_score(keyword: str, text: str) -> float`
- 個別キーワードの総合スコア計算
- 0.0〜1.0の範囲で返却

#### `_extract_integrated(text: str, top_n: int) -> List[Tuple[str, float]]`
- MeCabと正規表現の結果をマージ
- 統合スコアリングで再評価

### ユーティリティ関数

#### `compare_methods(text: str, top_n: int = 10)`
- **処理内容**:
  - 各抽出手法を実行
  - 結果を整形して表示
  - 手法間の共通キーワード分析
  - 全手法で共通、2手法で共通のキーワードを特定

#### `evaluate_coverage_potential(keywords: List[str], uncovered_text: str, analyzer=None) -> Dict[str, float]`
- **パラメータ**:
  - `keywords`: 抽出されたキーワードリスト
  - `uncovered_text`: 未カバーのテキスト
  - `analyzer`: SemanticCoverageインスタンス（オプション）
- **返り値**: 評価指標の辞書
  - キーワードカバレージ率
  - 複合語率（4文字以上）
  - 専門用語率（カタカナ3+、英大文字2+、漢字4+）
  - 意味的関連度（analyzerが提供された場合のみ）

#### `main()`
- サンプルテキストでのデモ実行
- 基本抽出、詳細比較、品質評価の3つを実施

## ストップワード

以下の一般的な日本語単語は除外されます：
- こと、もの、これ、それ、ため、よう
- ます、です、ある、いる、する、なる、できる
- 的、な、に、を、は、が、で、と、の、から、まで、等、など

## 重要キーワード（スコアブースト対象）

以下のキーワードは重要度が高く評価されます：
- AI関連：AI、人工知能、機械学習、深層学習、ディープラーニング
- NLP関連：自然言語処理、NLP、トランスフォーマー、BERT、GPT
- 技術用語：CNN、Vision Transformer、モデル、データ
- 応用分野：医療、診断、自動運転
- 課題関連：倫理、バイアス、課題、問題

## 実行例

```bash
# 基本的な実行
python regex_mecab.py

# 出力例：
✅ MeCabが利用可能です（複合名詞抽出モード）
================================================================================
基本的なキーワード抽出テスト
================================================================================

【統合版抽出結果（上位10件）】
  1. 人工知能
  2. 機械学習
  3. 深層学習
  4. 自然言語処理
  5. トランスフォーマー
  6. BERT
  7. GPT
  8. CNN
  9. Vision Transformer
  10. 医療診断
```

## 依存関係

### 必須
- Python 3.7+
- re（標準ライブラリ）
- collections（標準ライブラリ）
- typing（標準ライブラリ）

### オプション
- MeCab（形態素解析器）
- mecab-python3（MeCab Pythonバインディング）

MeCabがインストールされていない場合でも、正規表現モードで動作します。

## パフォーマンス考慮事項

1. **MeCabモード**
   - 精度：高い（特に複合名詞、専門用語）
   - 速度：中程度（形態素解析のオーバーヘッド）
   - メモリ：辞書ロードで数十MB使用

2. **正規表現モード**
   - 精度：中程度（パターンベース）
   - 速度：高速
   - メモリ：最小限

3. **統合モード**
   - 両手法の結果をマージ
   - 最も網羅的だが処理時間は増加

## トラブルシューティング

### MeCabが認識されない場合

```bash
# MeCabのインストール確認
which mecab

# Pythonバインディングのインストール
pip install mecab-python3

# 辞書パスの確認（macOSの場合）
export MECAB_PATH=/opt/homebrew/lib/libmecab.dylib
```

### 文字化けが発生する場合

```python
# UTF-8エンコーディングを明示的に指定
with open('file.txt', 'r', encoding='utf-8') as f:
    text = f.read()
```

## 今後の拡張案

1. **Word2Vec/BERT埋め込みとの統合**
   - 意味的類似度によるキーワードグルーピング
   - 文脈を考慮したキーワード重要度評価

2. **TF-IDF統合**
   - 文書集合全体での重要度評価
   - ドメイン特化型キーワード抽出

3. **多言語対応**
   - 英語、中国語などへの拡張
   - 言語自動判定機能

4. **カスタマイズ機能**
   - ユーザー定義のストップワード
   - ドメイン特化の重要キーワード辞書

## ライセンス

MITライセンス

## 作成者

このシステムは、RAG（Retrieval-Augmented Generation）システムのカバレージ改善プロジェクトの一環として開発されました。